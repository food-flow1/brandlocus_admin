'use client';

import React, { useState, useMemo, useCallback } from 'react';
import TimeRangeSelector, { TimeRange } from '@/components/TimeRangeSelector';
import { useDashboard } from '@/hooks/useDashboard';
import { DashboardFilterParams } from '@/lib/api/services/dashboard';

// Map TimeRange to API filter values
const timeRangeToFilter: Record<TimeRange, string> = {
    'all': '12months',
    '30days': '30days',
    '7days': '7days',
    '24hour': '24hour',
};

const DashboardCards = () => {
    const [selectedRange, setSelectedRange] = useState<TimeRange>('all');
    const [startDate, setStartDate] = useState<string>('');
    const [endDate, setEndDate] = useState<string>('');

    // Build API params
    const apiParams: DashboardFilterParams = useMemo(() => ({
        filter: timeRangeToFilter[selectedRange],
        startDate: startDate || undefined,
        endDate: endDate || undefined,
    }), [selectedRange, startDate, endDate]);

    // Fetch dashboard data from API
    const { data, isLoading } = useDashboard(apiParams);

    // Handle date selection from date picker
    const handleDateSelect = useCallback((date: Date) => {
        const formattedDate = date.toISOString().split('T')[0];
        // If no start date, set start date; otherwise set end date
        if (!startDate) {
            setStartDate(formattedDate);
        } else if (!endDate) {
            setEndDate(formattedDate);
        } else {
            // Reset and start over
            setStartDate(formattedDate);
            setEndDate('');
        }
    }, [startDate, endDate]);

    // Format number with commas
    const formatNumber = (num: number | string | undefined) => {
        if (num === undefined || num === null) return '0';
        const n = typeof num === 'string' ? parseFloat(num) : num;
        return n.toLocaleString();
    };

    // Determine change type from change value (number)
    const getChangeType = (change: number | undefined): 'positive' | 'negative' | 'neutral' => {
        if (change === undefined || change === null) return 'neutral';
        if (change > 0) return 'positive';
        if (change < 0) return 'negative';
        return 'neutral';
    };

    // Format change value as percentage string
    const formatChange = (change: number | undefined): string => {
        if (change === undefined || change === null) return '0%';
        const sign = change >= 0 ? '+' : '';
        return `${sign}${change.toFixed(1)}%`;
    };

    const cards = [
        {
            label: 'Total Conversations',
            value: formatNumber(data?.totalConversations),
            change: formatChange(data?.conversationChange),
            changeType: getChangeType(data?.conversationChange),
            icon: (
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="44" height="44" rx="22" fill="#DEDEFA" />
                    <rect x="2" y="2" width="44" height="44" rx="22" stroke="#EFEFFD" strokeWidth="4" />
                    <path d="M11.4 23.7999C11.5051 23.8787 11.6246 23.936 11.7518 23.9686C11.879 24.0012 12.0114 24.0084 12.1414 23.9898C12.2714 23.9712 12.3965 23.9272 12.5095 23.8603C12.6225 23.7934 12.7212 23.7049 12.8 23.5999C13.4055 22.7926 14.1906 22.1374 15.0931 21.6861C15.9957 21.2348 16.9909 20.9999 18 20.9999C19.0091 20.9999 20.0043 21.2348 20.9069 21.6861C21.8094 22.1374 22.5945 22.7926 23.2 23.5999C23.3593 23.8118 23.5963 23.9519 23.8588 23.9891C24.1214 24.0264 24.388 23.9579 24.6 23.7986C24.6756 23.7424 24.7425 23.6754 24.7987 23.5999C25.4042 22.7926 26.1893 22.1374 27.0919 21.6861C27.9944 21.2348 28.9897 20.9999 29.9988 20.9999C31.0078 20.9999 32.0031 21.2348 32.9056 21.6861C33.8082 22.1374 34.5933 22.7926 35.1987 23.5999C35.358 23.812 35.5951 23.9522 35.8578 23.9896C36.1204 24.027 36.3872 23.9585 36.5994 23.7992C36.8115 23.6399 36.9518 23.4029 36.9891 23.1402C37.0265 22.8775 36.958 22.6108 36.7987 22.3986C35.9136 21.2119 34.7332 20.2776 33.375 19.6886C34.1196 19.0088 34.6413 18.1197 34.8716 17.1381C35.1019 16.1565 35.03 15.1282 34.6654 14.1881C34.3009 13.2481 33.6606 12.4402 32.8287 11.8706C31.9967 11.3009 31.012 10.9961 30.0037 10.9961C28.9955 10.9961 28.0108 11.3009 27.1788 11.8706C26.3469 12.4402 25.7066 13.2481 25.3421 14.1881C24.9775 15.1282 24.9056 16.1565 25.1359 17.1381C25.3662 18.1197 25.8879 19.0088 26.6325 19.6886C25.6518 20.1127 24.7609 20.7198 24.0075 21.4774C23.2541 20.7198 22.3632 20.1127 21.3825 19.6886C22.1271 19.0088 22.6488 18.1197 22.8791 17.1381C23.1094 16.1565 23.0375 15.1282 22.6729 14.1881C22.3084 13.2481 21.6681 12.4402 20.8362 11.8706C20.0042 11.3009 19.0195 10.9961 18.0112 10.9961C17.003 10.9961 16.0183 11.3009 15.1863 11.8706C14.3544 12.4402 13.7141 13.2481 13.3496 14.1881C12.985 15.1282 12.9131 16.1565 13.1434 17.1381C13.3737 18.1197 13.8954 19.0088 14.64 19.6886C13.2758 20.2757 12.0896 21.2106 11.2 22.3999C11.1212 22.5049 11.0639 22.6245 11.0313 22.7517C10.9987 22.8789 10.9915 23.0113 11.0101 23.1413C11.0286 23.2713 11.0726 23.3964 11.1395 23.5094C11.2064 23.6224 11.2949 23.7211 11.4 23.7999ZM30 12.9999C30.5933 12.9999 31.1734 13.1758 31.6667 13.5055C32.1601 13.8351 32.5446 14.3036 32.7716 14.8518C32.9987 15.4 33.0581 16.0032 32.9424 16.5851C32.8266 17.1671 32.5409 17.7016 32.1213 18.1212C31.7018 18.5407 31.1672 18.8265 30.5853 18.9422C30.0033 19.058 29.4001 18.9986 28.8519 18.7715C28.3038 18.5444 27.8352 18.1599 27.5056 17.6666C27.1759 17.1732 27 16.5932 27 15.9999C27 15.2042 27.3161 14.4411 27.8787 13.8785C28.4413 13.3159 29.2044 12.9999 30 12.9999ZM18 12.9999C18.5933 12.9999 19.1734 13.1758 19.6667 13.5055C20.1601 13.8351 20.5446 14.3036 20.7716 14.8518C20.9987 15.4 21.0581 16.0032 20.9424 16.5851C20.8266 17.1671 20.5409 17.7016 20.1213 18.1212C19.7018 18.5407 19.1672 18.8265 18.5853 18.9422C18.0033 19.058 17.4001 18.9986 16.8519 18.7715C16.3038 18.5444 15.8352 18.1599 15.5056 17.6666C15.1759 17.1732 15 16.5932 15 15.9999C15 15.2042 15.3161 14.4411 15.8787 13.8785C16.4413 13.3159 17.2044 12.9999 18 12.9999ZM33.375 32.6886C34.1196 32.0088 34.6413 31.1197 34.8716 30.1381C35.1019 29.1565 35.03 28.1282 34.6654 27.1881C34.3009 26.2481 33.6606 25.4402 32.8287 24.8706C31.9967 24.3009 31.012 23.9961 30.0037 23.9961C28.9955 23.9961 28.0108 24.3009 27.1788 24.8706C26.3469 25.4402 25.7066 26.2481 25.3421 27.1881C24.9775 28.1282 24.9056 29.1565 25.1359 30.1381C25.3662 31.1197 25.8879 32.0088 26.6325 32.6886C25.6518 33.1127 24.7609 33.7198 24.0075 34.4774C23.2541 33.7198 22.3632 33.1127 21.3825 32.6886C22.1271 32.0088 22.6488 31.1197 22.8791 30.1381C23.1094 29.1565 23.0375 28.1282 22.6729 27.1881C22.3084 26.2481 21.6681 25.4402 20.8362 24.8706C20.0042 24.3009 19.0195 23.9961 18.0112 23.9961C17.003 23.9961 16.0183 24.3009 15.1863 24.8706C14.3544 25.4402 13.7141 26.2481 13.3496 27.1881C12.985 28.1282 12.9131 29.1565 13.1434 30.1381C13.3737 31.1197 13.8954 32.0088 14.64 32.6886C13.2758 33.2757 12.0896 34.2106 11.2 35.3999C11.1212 35.5049 11.0639 35.6245 11.0313 35.7517C10.9987 35.8789 10.9915 36.0113 11.0101 36.1413C11.0286 36.2713 11.0726 36.3964 11.1395 36.5094C11.2064 36.6224 11.2949 36.7211 11.4 36.7999C11.5051 36.8787 11.6246 36.936 11.7518 36.9686C11.879 37.0012 12.0114 37.0084 12.1414 36.9898C12.2714 36.9712 12.3965 36.9272 12.5095 36.8603C12.6225 36.7934 12.7212 36.7049 12.8 36.5999C13.4055 35.7926 14.1906 35.1374 15.0931 34.6861C15.9957 34.2348 16.9909 33.9999 18 33.9999C19.0091 33.9999 20.0043 34.2348 20.9069 34.6861C21.8094 35.1374 22.5945 35.7926 23.2 36.5999C23.3593 36.8118 23.5963 36.9519 23.8588 36.9891C24.1214 37.0264 24.388 36.9579 24.6 36.7986C24.6756 36.7424 24.7425 36.6754 24.7987 36.5999C25.4042 35.7926 26.1893 35.1374 27.0919 34.6861C27.9944 34.2348 28.9897 33.9999 29.9988 33.9999C31.0078 33.9999 32.0031 34.2348 32.9056 34.6861C33.8082 35.1374 34.5933 35.7926 35.1987 36.5999C35.358 36.812 35.5951 36.9522 35.8578 36.9896C36.1204 37.027 36.3872 36.9585 36.5994 36.7992C36.8115 36.6399 36.9518 36.4029 36.9891 36.1402C37.0265 35.8775 36.958 35.6108 36.7987 35.3986C35.9136 34.2119 34.7332 33.2776 33.375 32.6886ZM18 25.9999C18.5933 25.9999 19.1734 26.1758 19.6667 26.5055C20.1601 26.8351 20.5446 27.3036 20.7716 27.8518C20.9987 28.4 21.0581 29.0032 20.9424 29.5851C20.8266 30.1671 20.5409 30.7016 20.1213 31.1212C19.7018 31.5407 19.1672 31.8265 18.5853 31.9422C18.0033 32.058 17.4001 31.9986 16.8519 31.7715C16.3038 31.5444 15.8352 31.1599 15.5056 30.6666C15.1759 30.1732 15 29.5932 15 28.9999C15 28.2042 15.3161 27.4411 15.8787 26.8785C16.4413 26.3159 17.2044 25.9999 18 25.9999ZM30 25.9999C30.5933 25.9999 31.1734 26.1758 31.6667 26.5055C32.1601 26.8351 32.5446 27.3036 32.7716 27.8518C32.9987 28.4 33.0581 29.0032 32.9424 29.5851C32.8266 30.1671 32.5409 30.7016 32.1213 31.1212C31.7018 31.5407 31.1672 31.8265 30.5853 31.9422C30.0033 32.058 29.4001 31.9986 28.8519 31.7715C28.3038 31.5444 27.8352 31.1599 27.5056 30.6666C27.1759 30.1732 27 29.5932 27 28.9999C27 28.2042 27.3161 27.4411 27.8787 26.8785C28.4413 26.3159 29.2044 25.9999 30 25.9999Z" fill="#5C59E8" />
                </svg>
            ),
        },
        {
            label: 'Active Users',
            value: formatNumber(data?.activeUsers),
            change: formatChange(data?.userChange),
            changeType: getChangeType(data?.userChange),
            icon: (
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="44" height="44" rx="22" fill="#CFE7DC" />
                    <rect x="2" y="2" width="44" height="44" rx="22" stroke="#E7F4EE" strokeWidth="4" />
                    <path d="M25.5 24C25.5 24.2967 25.412 24.5867 25.2472 24.8334C25.0824 25.0801 24.8481 25.2723 24.574 25.3859C24.2999 25.4994 23.9983 25.5291 23.7074 25.4712C23.4164 25.4133 23.1491 25.2705 22.9393 25.0607C22.7296 24.8509 22.5867 24.5836 22.5288 24.2927C22.4709 24.0017 22.5006 23.7001 22.6142 23.426C22.7277 23.1519 22.92 22.9177 23.1666 22.7528C23.4133 22.588 23.7033 22.5 24 22.5C24.3978 22.5 24.7794 22.6581 25.0607 22.9394C25.342 23.2207 25.5 23.6022 25.5 24ZM18.5 22.5C18.2033 22.5 17.9133 22.588 17.6666 22.7528C17.42 22.9177 17.2277 23.1519 17.1142 23.426C17.0006 23.7001 16.9709 24.0017 17.0288 24.2927C17.0867 24.5836 17.2296 24.8509 17.4393 25.0607C17.6491 25.2705 17.9164 25.4133 18.2074 25.4712C18.4983 25.5291 18.7999 25.4994 19.074 25.3859C19.3481 25.2723 19.5824 25.0801 19.7472 24.8334C19.912 24.5867 20 24.2967 20 24C20 23.6022 19.842 23.2207 19.5607 22.9394C19.2794 22.6581 18.8978 22.5 18.5 22.5ZM29.5 22.5C29.2033 22.5 28.9133 22.588 28.6666 22.7528C28.42 22.9177 28.2277 23.1519 28.1142 23.426C28.0007 23.7001 27.9709 24.0017 28.0288 24.2927C28.0867 24.5836 28.2296 24.8509 28.4393 25.0607C28.6491 25.2705 28.9164 25.4133 29.2074 25.4712C29.4983 25.5291 29.7999 25.4994 30.074 25.3859C30.3481 25.2723 30.5824 25.0801 30.7472 24.8334C30.912 24.5867 31 24.2967 31 24C31 23.6022 30.842 23.2207 30.5607 22.9394C30.2794 22.6581 29.8978 22.5 29.5 22.5ZM37 24C37.0005 26.2445 36.4199 28.4508 35.3147 30.4042C34.2095 32.3577 32.6174 33.9917 30.6934 35.1473C28.7693 36.3029 26.5788 36.9407 24.3352 36.9986C22.0915 37.0564 19.8711 36.5324 17.89 35.4775L13.6337 36.8963C13.2814 37.0138 12.9032 37.0309 12.5417 36.9455C12.1801 36.8602 11.8495 36.6759 11.5868 36.4132C11.3241 36.1506 11.1398 35.8199 11.0545 35.4584C10.9692 35.0968 10.9862 34.7187 11.1037 34.3663L12.5225 30.11C11.5952 28.3666 11.0772 26.4348 11.008 24.4613C10.9387 22.4877 11.32 20.5244 12.1228 18.7202C12.9257 16.916 14.129 15.3185 15.6414 14.0488C17.1538 12.7791 18.9356 11.8706 20.8516 11.3924C22.7675 10.9141 24.7672 10.8786 26.699 11.2886C28.6307 11.6986 30.4436 12.5433 32.0001 13.7585C33.5566 14.9737 34.8158 16.5276 35.6822 18.3022C36.5485 20.0767 36.9992 22.0253 37 24ZM35 24C34.9995 22.3127 34.6109 20.6481 33.8641 19.135C33.1174 17.6219 32.0325 16.3008 30.6935 15.2741C29.3545 14.2473 27.7973 13.5424 26.1422 13.2138C24.4872 12.8852 22.7787 12.9417 21.149 13.379C19.5194 13.8164 18.0121 14.6227 16.7439 15.7358C15.4758 16.8488 14.4806 18.2387 13.8356 19.7979C13.1905 21.357 12.9128 23.0437 13.0239 24.7274C13.135 26.4111 13.6319 28.0466 14.4762 29.5075C14.5471 29.6302 14.5911 29.7665 14.6053 29.9074C14.6196 30.0484 14.6037 30.1907 14.5587 30.325L13 35L17.675 33.4413C17.7768 33.4066 17.8837 33.3888 17.9912 33.3888C18.1669 33.3891 18.3393 33.4357 18.4912 33.5238C20.1635 34.4913 22.0611 35.0013 23.9931 35.0026C25.925 35.0038 27.8232 34.4961 29.4967 33.5307C31.1702 32.5653 32.5599 31.1762 33.526 29.5031C34.492 27.83 35.0004 25.932 35 24Z" fill="#076504" />
                </svg>

            ),
        },
    ];

    return (
        <div className="space-y-6">
            {/* Time Range Selector */}
            <TimeRangeSelector
                selectedRange={selectedRange}
                onRangeChange={setSelectedRange}
                onDateSelect={handleDateSelect}
                selectedDate={startDate ? new Date(startDate) : undefined}
            />

            {/* Metric Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {isLoading ? (
                    // Loading skeleton
                    Array.from({ length: 3 }).map((_, index) => (
                        <div
                            key={index}
                            className="bg-white rounded-lg p-6 shadow-sm border border-gray-200 animate-pulse"
                        >
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-12 h-12 bg-gray-200 rounded-full" />
                            </div>
                            <div>
                                <div className="h-4 w-24 bg-gray-200 rounded mb-2" />
                                <div className="flex items-center gap-2 pt-2">
                                    <div className="h-8 w-20 bg-gray-200 rounded" />
                                    <div className="h-6 w-12 bg-gray-200 rounded-full" />
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    cards.map((card, index) => (
                        <div
                            key={index}
                            className="bg-white rounded-lg p-6 shadow-sm border border-gray-200"
                        >
                            <div className="flex items-start justify-between mb-4">
                                <div className={``}>
                                    {card.icon}
                                </div>

                            </div>
                            <div>
                                <p className="text-sm font-medium text-[#667085] mb-1">{card.label}</p>
                                <div className="flex items-center gap-2 pt-2">
                                    <p className="text-2xl font-semibold text-gray-900">{card.value}</p>
                                    <div
                                        className={`px-2.5 py-1 w-fit rounded-full text-xs font-medium ${card.changeType === 'positive'
                                            ? 'bg-[#E7F4EE] text-[#0D894F]'
                                            : card.changeType === 'negative'
                                                ? 'bg-[#FEEDEC] text-[#F04438]'
                                                : 'bg-gray-100 text-gray-600'
                                            }`}
                                    >
                                        {card.change}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default DashboardCards;